.. _aws-continuous-deployment:

Continuous deployment
#####################

.. contents::
   :local:
   :depth: 2

You can enable continuous deployment of the changes in your source repository to an AWS account.

.. note::

   It is optional to keep the deployment in your account automatically synchronized with the source code repository.

For the continuous deployment to work, you need to fork the source code to register the webhook listener that triggers an upgrade of your deployment.

After forking, make sure to update the ``repository.url`` in the :file:`package.json` file in your fork.

This sets up an AWS CodePipeline, which triggers a CodeBuild project for every push to the :file:`saga` branch.
You can configure the branch in the ``deploy.branch`` property of the :file:`package.json` file.
The CodeBuild project upgrades the CloudFormation stack, which contains the nRF Asset Tracker resources.

A second CodePipeline will be set up for the web application, which triggers a CodeBuild project for every push to the :file:`saga` branch.
You can configure the repository URL and the branch for the web app in the ``deploy.webApp`` property of the :file:`package.json` file.
The CodeBuild project upgrades the web application deployment on the S3 bucket.

Provide GitHub credentials
**************************

You need to create a `developer token <https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line>`_ with ``repo`` and ``admin:repo_hook`` permissions for an account that has write permissions to your repository.

.. note::

   It is recommended to use a separate GitHub account instead of your personal GitHub account.

You need to store this token in `AWS ParameterStore <https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html>`_ and it is a manual *one-time* step done through AWS CLI  by using the following command:

.. code-block:: bash

    node cli configure-api codebuild github token "<Github Token>"

Enable continuous deployment
****************************

After providing the GitHub credentials, you can set up the continuous deployment by enabling it before deploying the stack:

.. code-block:: bash

    node cli configure-api context stack cd 1
    npx cdk deploy '*'

Check the status of the continuous deployment
*********************************************

If you want to check the status of the continuous deployment after you have made the changes, use the following CLI command:

.. code-block:: bash

    node cli cd

The following image shows the sample output generated by the command:

.. figure:: ./cli-cd.png
   :alt: Output of node cli cd

   Output of ``node cli cd``
