<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Continuous integration of firmware &mdash; nRF Asset Tracker f2fff594bcd6650f0e8b2764f10aeefbaf71e70c documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/common.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Connect using a real device" href="../devices/Index.html" />
    <link rel="prev" title="Building the project using GitHub actions" href="../firmware/aws/BuildingUsingGitHub.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> nRF Asset Tracker
          </a>
              <div class="version">
                v1.5.x
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../project/Index.html">Project overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="Index.html">AWS cloud components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app/Index.html">Cat Tracker web application</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../firmware/Index.html">Firmware</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../firmware/aws/Index.html">Firmware for the AWS cloud components</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../firmware/aws/BuildingUsingLocalSystem.html">Building the project using your local system</a></li>
<li class="toctree-l3"><a class="reference internal" href="../firmware/aws/BuildingUsingDocker.html">Building the project using Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../firmware/aws/BuildingUsingGitHub.html">Building the project using GitHub actions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Continuous integration of firmware</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../devices/Index.html">Connect using a real device</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guides/Index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/search?q=org%3ANordicSemiconductor+nrf-asset-tracker&amp;type=repositories">GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CODE_OF_CONDUCT.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing to the project</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">nRF Asset Tracker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../firmware/Index.html">Firmware</a> &raquo;</li>
          <li><a href="../firmware/aws/Index.html">Firmware for the AWS cloud components</a> &raquo;</li>
      <li>Continuous integration of firmware</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/NordicSemiconductor/asset-tracker-cloud-docs/blob/v1.5.x/docs/aws/FirmwareContinuousIntegration.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="continuous-integration-of-firmware">
<span id="aws-firmware-ci"></span><h1>Continuous integration of firmware<a class="headerlink" href="#continuous-integration-of-firmware" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#preparation" id="id3">Preparation</a></p></li>
<li><p><a class="reference internal" href="#firmware-ci-runner-setup" id="id4">Firmware CI runner setup</a></p></li>
</ul>
</div>
<p>The AWS implementation of the nRF Asset Tracker provides the resources for continuous testing of the firmware using real hardware.</p>
<section id="overview">
<h2><a class="toc-backref" href="#id2">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Every commit to the <a class="reference external" href="https://github.com/NordicSemiconductor/asset-tracker-cloud-firmware-aws">firmware repository</a> will trigger a CI run.
The CI run results in the following actions:</p>
<ol class="arabic simple">
<li><p>Creating a new device and credentials on AWS IoT.</p></li>
<li><p>Building a firmware that has the device ID hardcoded for the MQTT client ID.</p></li>
<li><p>Creating an AWS IoT job with the firmware and the credentials, which is selected by the <a class="reference external" href="https://github.com/NordicSemiconductor/cloud-aws-firmware-ci-runner-js">Firmware CI runner</a>. See <a class="reference internal" href="#firmware-ci-runner-setup"><span class="std std-ref">Firmware CI runner setup</span></a>.</p></li>
<li><p>Observing the firmware CI run until completion.</p></li>
<li><p>Downloading the log result from Amazon S3 bucket.</p></li>
<li><p>Running assertions against the log result.</p></li>
</ol>
<p>The Firmware CI runner is running on a Raspberry Pi connected to AWS IoT, where it receives the jobs to execute.
Following are the actions performed by the Firmware CI runner:</p>
<ol class="arabic simple">
<li><p>Programming the firmware and the optional credentials using the connected debugger to the connected nRF9160 DK or Thingy:91.</p></li>
<li><p>Collecting all the log output until one of the following conditions occur:</p>
<ol class="loweralpha simple">
<li><p>A timeout is reached</p></li>
<li><p>A stop condition is reached. (Wait for a log output to match a string.)</p></li>
</ol>
</li>
<li><p>Uploading the logs to S3 bucket</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These devices connect to the existing instance of the nRF Asset Tracker, so the firmware tests will not set up a new empty nRF Asset Tracker AWS environment for every test.
It runs against the production environment.
This is to ensure that the firmware release will work with the existing solution.
This approach is designed for <a class="reference external" href="https://thinkinglabs.io/talks/feature-branching-considered-evil.html">trunk-based development</a>.</p>
</div>
</section>
<section id="preparation">
<h2><a class="toc-backref" href="#id3">Preparation</a><a class="headerlink" href="#preparation" title="Permalink to this headline"></a></h2>
<p>Enable the Firmware CI resources of the nRF Asset Tracker that allow GitHub Actions to create test devices.
Also enable the Firmware CI runner to connect before deploying the stack (see <a class="reference internal" href="GettingStarted/Index.html#aws-getting-started"><span class="std std-ref">Getting Started</span></a>).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>node cli configure-api context stack firmware-ci <span class="m">1</span>
npx cdk deploy <span class="s1">&#39;*&#39;</span>
</pre></div>
</div>
<p>Print the AWS Key for the CI runner on GitHub Actions using the following command:</p>
<pre class="highlight literal-block">node cli firmware-ci -s

Region: &quot;<em>Region</em>&quot;
Bucket name: &quot;<em>Bucket name</em>&quot;
Access Key ID: &quot;<em>AWS Access Key ID</em>&quot;
Secret Access Key: &quot;<em>AWS Secret Access Key</em>&quot;</pre>
<p>At this stage, you can create a new IoT Thing to be used for a Firmware CI runner, by running the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>node cli firmware-ci -c
</pre></div>
</div>
<p>To delete a device, use the following command:</p>
<pre class="highlight literal-block">node cli firmware-ci -r &quot;<em>deviceId</em>&quot;</pre>
<p>Configure the following parameters as secrets on the firmware GitHub repository:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code> (as printed above)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code> (as printed above)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AWS_REGION</span></code> (as printed above)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STACK_NAME</span></code> (the stack name of your production environment, usually <code class="docutils literal notranslate"><span class="pre">nrf-asset-tracker</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEVICE_ID</span></code> (the created Firmware CI runner device, for example, <code class="docutils literal notranslate"><span class="pre">firmware-ci-3c431c57-e524-4010-b269-371cb53538b6</span></code>)</p></li>
</ul>
</section>
<section id="firmware-ci-runner-setup">
<span id="id1"></span><h2><a class="toc-backref" href="#id4">Firmware CI runner setup</a><a class="headerlink" href="#firmware-ci-runner-setup" title="Permalink to this headline"></a></h2>
<p>To set up Firmware CI runner, complete the following steps:</p>
<ol class="arabic">
<li><p>Download <a class="reference external" href="https://www.segger.com/downloads/jlink/">JLink</a> for your platform.</p></li>
<li><p>Install <a class="reference external" href="https://github.com/NordicSemiconductor/cloud-aws-firmware-ci-runner-js.git">firmware-ci-runner-aws</a> by running the following commands:</p>
<pre class="literal-block">git clone --branch v1.5.x --single-branch \
  <a class="reference external" href="https://github.com/NordicSemiconductor/cloud-aws-firmware-ci-runner-js.git">https://github.com/NordicSemiconductor/cloud-aws-firmware-ci-runner-js.git</a>
cd firmware-ci-runner-aws
npm ci
npx tsc</pre>
</li>
<li><p>Provide the following environment variables. Use the path to the JLink folder (for example, <code class="file docutils literal notranslate"><span class="pre">~/JLink_Linux_V686_arm64/</span></code>) that is created during the installation in step 1:</p>
<pre class="highlight literal-block">export AWS_ACCESS_KEY_ID=&quot;<em>AWS Access Key ID printed above</em>&quot;
export AWS_SECRET_ACCESS_KEY=&quot;<em>AWS Secret Access Key printed above</em>&quot;
export REGION=&quot;<em>Region printed above</em>&quot;
export BUCKET_NAME=&quot;<em>Bucket name printed above</em>&quot;
export PATH=&quot;<em>Path to JLINK</em>&quot;:$PATH</pre>
<p>The recommended workflow is to use a <a class="reference external" href="https://direnv.net/">direnv</a> plugin for your shell, which locates the environment variables in a <code class="file docutils literal notranslate"><span class="pre">.envrc</span></code> file in the project folder and automatically exports them.
Create a new file <code class="file docutils literal notranslate"><span class="pre">.envrc</span></code> in the project folder and add the credentials that are provided to you after you have created the new user.</p>
</li>
<li><p>Copy the JSON file containing the certificate.</p></li>
<li><p>Run the following command:</p>
<pre class="highlight literal-block">node cli run &quot;<em>device</em>&quot; &quot;<em>path to certificate.json</em>&quot;</pre>
<p><code class="file docutils literal notranslate"><span class="pre">device</span></code> is the Linux file to which the device is connected, for example, <code class="docutils literal notranslate"><span class="pre">/dev/ttyACM0</span></code>.</p>
</li>
</ol>
<p>The Firmware CI starts to process all the scheduled jobs one after another.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../firmware/aws/BuildingUsingGitHub.html" class="btn btn-neutral float-left" title="Building the project using GitHub actions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../devices/Index.html" class="btn btn-neutral float-right" title="Connect using a real device" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Nordic Semiconductor ASA | nordicsemi.no.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>