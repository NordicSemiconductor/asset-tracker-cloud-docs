.. _aws-continuous-deployment:

Continuous deployment
#####################

.. contents::
   :local:
   :depth: 2

You can enable continuous deployment of the changes in your source repository to an AWS account.

.. note::

   It is optional to keep the deployment in your account automatically synchronized with the source code repository.

For the continuous deployment to work, complete the following steps:

1. Fork the source code to register the webhook listener that triggers an upgrade of your deployment.

#. Make sure to update the ``repository.url`` in the :file:`package.json` file in your fork.

   This sets up an AWS CodePipeline, which triggers a CodeBuild project for every push to the ``saga`` branch.
   
#. Configure the branch in the ``deploy.branch`` property of the :file:`package.json` file.

   The CodeBuild project upgrades the CloudFormation stack, which contains the nRF Asset Tracker resources.

A second CodePipeline will be set up for the web application, which triggers a CodeBuild project for every push to the :file:`saga` branch.
Configure the repository URL and the branch for the web application in the ``deploy.webApp`` property of the :file:`package.json` file.
The CodeBuild project upgrades the web application deployment on the S3 bucket.

Provide GitHub credentials
**************************

You need to create a `developer token <https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line>`_ with ``repo`` and ``admin:repo_hook`` permissions for an account that has write permissions to your repository.

.. note::

   It is recommended to use a separate GitHub account instead of your personal GitHub account.

To store the token in `AWS ParameterStore <https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html>`_, use the following command in the AWS CLI:

.. parsed-literal::
   :class: highlight

    node cli configure-api codebuild github token "*Github Token*"

This is a manual one-time step.

Enable continuous deployment
****************************

After providing the GitHub credentials, set up the continuous deployment by enabling it before deploying the stack:

.. code-block:: bash

    node cli configure-api context stack cd 1
    npx cdk deploy '*'

Check the status of the continuous deployment
*********************************************

To check the status of the continuous deployment after you have made the changes, use the following CLI command:

.. code-block:: bash

    node cli cd

The following image shows a sample output generated by the command:

.. figure:: ./cli-cd.png
   :alt: Output of node cli cd

   Output of the ``node cli cd`` command
